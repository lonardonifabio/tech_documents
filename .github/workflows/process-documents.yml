name: Process Documents and Deploy

on:
  push:
    branches: [ main, master ]
    paths:
      - 'documents/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'documents/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  process-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch all history for proper file tracking
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pypdf hashlib-compat
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm ci
    
    - name: Process documents
      run: |
        echo "Processing documents..."
        python scripts/auto_update.py
        echo "Documents processed successfully"
    
    - name: Build website
      run: |
        echo "Building website..."
        npm run build
        echo "Website built successfully"
    
    - name: Commit updated documents.json if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        if [[ -n $(git status --porcelain) ]]; then
          echo "Changes detected, committing..."
          git add data/documents.json dist/data/documents.json data/processed_files.json
          git commit -m "Auto-update documents database [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
        else
          echo "No changes to commit"
        fi
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        force_orphan: true
